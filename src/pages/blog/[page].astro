---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const sortedPosts = allPosts.sort((a, b) => {
    const idA = parseInt(a.data.id || a.slug);
    const idB = parseInt(b.data.id || b.slug);
    return idB - idA; // 新しい番号から順番に表示
  });

  // ページネーション設定
  const postsPerPage = 5;
  const totalPages = Math.ceil(sortedPosts.length / postsPerPage);

  // 動的にページを生成
  const paths: any[] = [];
  
  // 2ページ目以降（/blog/2, /blog/3, ...）
  for (let i = 2; i <= totalPages; i++) {
    const startIndex = (i - 1) * postsPerPage;
    const endIndex = startIndex + postsPerPage;
    
    paths.push({
      params: { page: i.toString() },
      props: {
        posts: sortedPosts.slice(startIndex, endIndex),
        currentPage: i,
        totalPages,
        hasPrevPage: true,
        hasNextPage: i < totalPages,
        prevPage: i - 1,
        nextPage: i < totalPages ? i + 1 : null
      }
    });
  }

  return paths;
}

const { posts, currentPage, totalPages, hasPrevPage, hasNextPage, prevPage, nextPage } = Astro.props as {
  posts: any[];
  currentPage: number;
  totalPages: number;
  hasPrevPage: boolean;
  hasNextPage: boolean;
  prevPage: number;
  nextPage: number | null;
};
---

<Layout title="Blog - Paper After Word" currentPage="blog">
  <div class="back">
    <a href="/">← トップに戻る</a>
  </div>

  <div class="page-header">
    <h1>Blog</h1>
    <p>本を読んで、読んだ本を折り紙にする。</p>
  </div>

  <main class="content">
    <div class="posts">
      {posts.map((post) => (
        <article class="post">
          <div class="post-content">
            <h3><a href={`/blog/${post.data.id || post.slug}`}>{post.data.title}</a></h3>
            <div class="meta">
              {post.data.author} · {new Date(post.data.date).toLocaleDateString('ja-JP', { year: 'numeric', month: 'numeric', day: 'numeric' })}
            </div>
            <p><a href={`/blog/${post.data.id || post.slug}`}>{post.data.description}</a></p>
          </div>
          {post.data.images?.bookCover && (
            <div class="post-images">
              <a href={`/blog/${post.data.id || post.slug}`}>
                <img src={post.data.images.bookCover} alt={post.data.title} />
              </a>
            </div>
          )}
        </article>
      ))}
    </div>

    <!-- ページネーション -->
    {totalPages > 1 && (
      <nav class="pagination">
        <div class="pagination-info">
          {currentPage} / {totalPages} ページ
        </div>

        <div class="pagination-links">
          {hasPrevPage && (
            <a href={prevPage === 1 ? "/blog" : `/blog/${prevPage}`} class="pagination-link prev">
              ← 前のページ
            </a>
          )}

          <div class="pagination-numbers">
            {Array.from({ length: totalPages }, (_, i) => i + 1).map((pageNum) => (
              <a 
                href={pageNum === 1 ? "/blog" : `/blog/${pageNum}`} 
                class={`pagination-link ${pageNum === currentPage ? 'current' : ''}`}
              >
                {pageNum}
              </a>
            ))}
          </div>

          {hasNextPage && (
            <a href={`/blog/${nextPage}`} class="pagination-link next">
              次のページ →
            </a>
          )}
        </div>
      </nav>
    )}
  </main>
</Layout>

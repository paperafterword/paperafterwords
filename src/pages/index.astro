---
import { getCollection } from 'astro:content';
import Layout from '../layouts/Layout.astro';

const allPosts = await getCollection('blog');

// ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ‰è¨˜äº‹ã®IDã‚’æŒ‡å®šï¼ˆé †ç•ªé€šã‚Šã«è¡¨ç¤ºï¼‰
const featuredPostIds = ['049', '050','047', '048','007']; 

// ãƒ•ã‚£ãƒ¼ãƒãƒ£ãƒ¼ãƒ‰è¨˜äº‹ã‚’æŒ‡å®šã•ã‚ŒãŸé †ç•ªã§å–å¾—
const posts = featuredPostIds.map(id => 
  allPosts.find(post => post.data.id === id)
).filter(Boolean); // undefinedã‚’é™¤å¤–

// Galleryç”¨ã®æŠ˜ã‚Šç´™ä½œå“ã‚’å–å¾—
let galleryItems: Array<{
  id: string;
  title: string;
  author: string;
  publisher?: string;
  description: string;
  imagePath: string;
  tags: string[];
}> = [];

// æŠ˜ã‚Šç´™ä½œå“ãŒã‚ã‚‹æŠ•ç¨¿ã®ã¿ã‚’å¯¾è±¡ã¨ã™ã‚‹
for (const post of allPosts) {
  if (post.data.images?.origami && !post.data.title.includes('ã‚’æŠ˜ã‚‰ãªã„')) {
    const origamiImages = Array.isArray(post.data.images.origami) 
      ? post.data.images.origami 
      : [post.data.images.origami];
    
    if (origamiImages.length > 0) {
      galleryItems.push({
        id: post.data.id || post.slug,
        title: post.data.title,
        author: post.data.author,
        publisher: post.data.publisher,
        description: post.data.description,
        imagePath: origamiImages[0], // æœ€åˆã®æŠ˜ã‚Šç´™ç”»åƒã‚’ä½¿ç”¨
        tags: post.data.tags || []
      });
    }
  }
}

// IDé †ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
galleryItems.sort((a, b) => parseInt(b.id) - parseInt(a.id));
---

<Layout title="Paper After Word" currentPage="top">

  <div class="page-header">
    <h1>Paper After Word</h1>
    <p>æœ¬ã‚’èª­ã‚“ã§ã€èª­ã‚“ã æœ¬ã‚’æŠ˜ã‚Šç´™ã«ã™ã‚‹ã€‚</p>
  </div>

    <main class="content">
        <figure class="camera-photo-container">
          <canvas id="origami-canvas" class="camera-photo"></canvas>
          <figcaption class="photo-caption">
            Â« Fais ce que voudras.Â» æ±ã®æ¬²ã™ã‚‹ã¨ã“ã‚ã‚’ç‚ºã›
            <span class="quote-author">â€” ãƒ•ãƒ©ãƒ³ã‚½ãƒ¯ãƒ»ãƒ©ãƒ–ãƒ¬ãƒ¼</span>
          </figcaption>
        </figure>
      <div class="intro">
        <p>æœ¬ã¨ã„ã†ã‚‚ã®ã¯ã€èª­ã¿çµ‚ãˆãŸå¾Œã€ãŸã æ£šã«ä¸¦ã¹ã¦ãŠãã°ã‹ã‚Šã§ã¯ã€ã©ã†ã«ã‚‚ãã®ä½™æƒ…ãŒç©ºã«æ•£ã£ã¦ã—ã¾ã†ã‚ˆã†ã«æ€ã‚ã‚Œã‚‹ã€‚<br />
          æŠ˜ã‚Šç´™ãŒå¥½ãã§ã€ã›ã£ã‹ãç´™ãŒãã“ã«ã‚ã‚‹ã®ãªã‚‰...
        </p>
        <p>ãã“ã«ç©ã¿é‡ãªã£ãŸç´™ã®å±±ã‚’ã€é™ã‹ã«åˆ¥ã®å§¿ã¸ã¨æŠ˜ã‚Šå¤‰ãˆã¦ã¿ãŸããªã‚‹ã€‚æ–‡å­—ã¯ã™ã§ã«èƒ¸ã®è£¡ã«æ²ˆã¿è¾¼ã¿ã€ãã®ç”¨ã‚’çµ‚ãˆãŸç´™ã¯ã€ä»Šã‚„å½¢ãã®ã‚‚ã®ã®ãŸã‚ã«åœ¨ã‚‹ã€‚</p>
        <p>ã“ã“ã§ã¯ã€èª­ã¿çµ‚ãˆãŸæœ¬ã®ç´™ã‚’æŠ˜ã‚Šç´™ã«ã—ã€æœ¬ã®æ„Ÿæƒ³ã¨åˆã‚ã›ã¦ãã®è¨˜éŒ²ã‚’æ®‹ã™ã€‚<br />
          æ„å‘³ãŒã‚ã‚‹ã‹ã©ã†ã‹ã¯ã‚ã‹ã‚‰ãªã„ãŒã€æ‰‹ã‚’å‹•ã‹ã—ã¦ã„ã‚‹ã¨ã€ãã®ã“ã¨è‡ªä½“ãŒå°‘ã—ãŠã‚‚ã—ã‚ã„ã€‚</p>
        
          <a href="/story" class="more-posts-link">
            ã‚ã‚‰ã™ã˜ã‚’èª­ã‚€
          </a>
      </div>


      <h2 id="blog" class="section-title">Works and Reviews</h2>    
      <p>ä½œå“ä¸€è¦§</p>  
      <div class="posts">
        {posts.map((post) => (
          <article class="post">
            <div class="post-content">
              <h3><a href={`/blog/${post.data.id || post.slug}`}>{post.data.title}</a></h3>
              <div class="meta">
                <span class="author-info">
                  {post.data.author}
                  {post.data.translator && <span>ï¼ˆè¨³ï¼š{post.data.translator}ï¼‰</span>}
                  {post.data.publisher && <span class="publisher"> / {post.data.publisher}</span>}
                </span>
              </div>
              <p><a href={`/blog/${post.data.id || post.slug}`}>{post.data.description}</a></p>
            </div>
            {post.data.images?.bookCover && (
              <div class="post-images">
                <a href={`/blog/${post.data.id || post.slug}`}>
                  <img src={post.data.images.bookCover} alt={post.data.title} loading="lazy" decoding="async" />
                </a>
              </div>
            )}
          </article>
        ))}
      </div>
      
      <!-- ä»–ã®ä½œå“ã‚’è¦‹ã‚‹ãƒªãƒ³ã‚¯ -->
      {allPosts.length > 5 && (
        <div class="more-posts">
          <a href="/blog" class="more-posts-link">
            ä»–ã®ä½œå“ã‚’è¦‹ã‚‹
          </a>
        </div>
      )}
      
      <section id="gallery" class="section">
      <h2 id="blog" class="section-title">Gallery</h2>    
      <p>ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä½œå“ã‚’è¦‹ã‚‹</p>  
        {galleryItems.length > 0 ? (
          <div class="gallery-container">
            <div class="gallery-grid">
              {galleryItems.map((item) => (
                <div class="gallery-item">
                  <a href={`/blog/${item.id}`} class="gallery-link">
                    <img src={item.imagePath} alt={`${item.title}ã®æŠ˜ã‚Šç´™ä½œå“`} class="gallery-image" />
                  </a>
                </div>
              ))}
            </div>
          </div>
        ) : (
          <p class="section-text">æŠ˜ã‚Šç´™ä½œå“ã®ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã¯æº–å‚™ä¸­ã§ã™ã€‚</p>
        )}
      </section>
      
      <!-- <section id="shop" class="section">
        <h2>Shop</h2>
        <p class="section-text">ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚·ãƒ§ãƒƒãƒ—ã¯æº–å‚™ä¸­ã§ã™ã€‚</p>
        <div class="shop-image">
          <img src="/assets/paperafterword.jpg" alt="Paper After Word" />
        </div>
      </section> -->
      
      <section id="sns" class="section">
        <h2 class="section-title">SNS</h2>
        <div class="sns-links">
          <a href="https://twitter.com/paperafterword" target="_blank" rel="noopener noreferrer" class="sns-link">
            <span>ğ•</span>
          </a>
          <a href="https://jp.pinterest.com/paperafterword/" target="_blank" rel="noopener noreferrer" class="sns-link">
            <img src="/assets/pinterest.png" alt="Pinterest">
          </a>
        </div>
      </section>
</Layout>

<script>
  const img = new Image();
  img.src = "/assets/zatto.png";
  img.onload = () => {
    const origW = img.width;
    const origH = img.height;

    const canvas = document.getElementById("origami-canvas");
    const ctx = canvas.getContext("2d");
    
    // é«˜å“è³ªãªæç”»è¨­å®š
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'high';

    function ease(t) { return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2; }

    function setupAnimation(W, H) {
      // === æ¨ªæŠ˜ã‚Šï¼ˆç¬¬1æ®µéšï¼‰ ===
      function drawHorizontal1(progress) {
        const t = ease(progress);
        const angle = t * Math.PI;
        const cos = Math.cos(angle);
        const flapW = Math.abs(cos) * (W / 2);

        ctx.clearRect(0, 0, W, H);

        // å·¦åŠåˆ†ï¼ˆç”»åƒï¼‰
        ctx.drawImage(img, 0, 0, origW / 2, origH, 0, 0, W / 2, H);

        // å³åŠåˆ†ï¼ˆæŠ˜ã‚Œã‚‹ï¼‰
        if (cos >= 0) {
          ctx.drawImage(img, origW / 2, 0, origW / 2, origH, W / 2, 0, flapW, H);
        } else {
          ctx.fillStyle = "#f5f5dc";
          ctx.fillRect(W / 2 - flapW, 0, flapW, H);
        }

        // æŠ˜ã‚Šç›®ã®ç·šï¼ˆ1å›ç›®ã®æ¨ªæŠ˜ã‚Šï¼‰
        if (progress > 0.05 && progress < 0.95) {
          ctx.strokeStyle = "#ccc";
          ctx.lineWidth = 0.5;
          ctx.beginPath();
          ctx.moveTo(W / 2, 0);
          ctx.lineTo(W / 2, H);
          ctx.stroke();
        }

        // å½±
        if (angle > Math.PI / 2 && angle < Math.PI) {
          const edgeX = W / 2 - flapW;
          const ratio = (angle - Math.PI / 2) / (Math.PI / 2);

          // æ¿ƒã•ã¯å¾ŒåŠã§æ€¥ã«æš—ããªã‚‹
          let alpha = 0.5 * Math.pow(ratio, 1.5);
          if (angle >= Math.PI - 0.01) alpha = 0;

          // å½±ã®é•·ã•ã¯æœ€åˆã¯ä¸€æ°—ã«ä¼¸ã³ã€å¾ŒåŠã¯ç·©ã‚„ã‹
          const shadowLen = (W / 2) * Math.sin(ratio * Math.PI / 2);

          const grad = ctx.createLinearGradient(edgeX, 0, edgeX - shadowLen, 0);
          grad.addColorStop(0, `rgba(0,0,0,${alpha})`);
          grad.addColorStop(0.3, `rgba(0,0,0,${alpha * 0.6})`);
          grad.addColorStop(1, "rgba(0,0,0,0)");

          ctx.fillStyle = grad;
          ctx.fillRect(edgeX - shadowLen, 0, shadowLen, H);
        }
      }

      // === ç¸¦æŠ˜ã‚Šï¼ˆç¬¬2æ®µéšï¼šç™½ç´™ï¼‰ ===
      function drawVertical(progress) {
        const t = ease(progress);
        const angle = t * Math.PI;
        const cos = Math.cos(angle);
        const flapH = Math.abs(cos) * (H / 2);

        ctx.clearRect(0, 0, W / 2, H);

        ctx.fillStyle = "#f5f5dc";
        ctx.fillRect(0, 0, W / 2, H / 2);

        ctx.fillStyle = "#f5f5dc";
        if (cos >= 0) {
          ctx.fillRect(0, H / 2, W / 2, flapH);
        } else {
          ctx.fillRect(0, H / 2 - flapH, W / 2, flapH);
        }

        // æŠ˜ã‚Šç›®ã®ç·šï¼ˆ2å›ç›®ã®ç¸¦æŠ˜ã‚Šï¼‰
        if (progress > 0.05 && progress < 0.95) {
          ctx.strokeStyle = "#ccc";
          ctx.lineWidth = 0.5;
          ctx.beginPath();
          ctx.moveTo(0, H / 2);
          ctx.lineTo(W / 2, H / 2);
          ctx.stroke();
        }

        if (angle > Math.PI / 2 && angle < Math.PI) {
          const edgeY = H / 2 - flapH;
          const ratio = (angle - Math.PI / 2) / (Math.PI / 2);
          let alpha = 0.4 * ratio;
          if (angle >= Math.PI - 0.01) alpha = 0;
          const shadowLen = (H / 2) * ratio;

          const grad = ctx.createLinearGradient(0, edgeY, 0, edgeY - shadowLen);
          grad.addColorStop(0, `rgba(0,0,0,${alpha})`);
          grad.addColorStop(1, "rgba(0,0,0,0)");

          ctx.fillStyle = grad;
          ctx.fillRect(0, edgeY - shadowLen, W / 2, shadowLen);
        }
      }

        // === æ¨ªæŠ˜ã‚Šï¼ˆç¬¬3æ®µéšï¼šç™½ç´™ï¼‰ ===
        function drawHorizontal2(progress) {
          const t = ease(progress);
          const angle = t * Math.PI;
          const cos = Math.cos(angle);
          const flapW = Math.abs(cos) * (W / 4);

          ctx.clearRect(0, 0, W / 2, H / 2);

          ctx.fillStyle = "#f5f5dc";
          ctx.fillRect(0, 0, W / 4, H / 2);

          ctx.fillStyle = "#f5f5dc";
          if (cos >= 0) {
            ctx.fillRect(W / 4, 0, flapW, H / 2);
          } else {
            ctx.fillRect(W / 4 - flapW, 0, flapW, H / 2);
          }

          // æŠ˜ã‚Šç›®ã®ç·šï¼ˆ3å›ç›®ã®æ¨ªæŠ˜ã‚Šï¼‰
          if (progress > 0.05 && progress < 0.95) {
            ctx.strokeStyle = "#ccc";
            ctx.lineWidth = 0.5;
            ctx.beginPath();
            ctx.moveTo(W / 4, 0);
            ctx.lineTo(W / 4, H / 2);
            ctx.stroke();
          }

          if (angle > Math.PI / 2 && angle < Math.PI) {
            const edgeX = W / 4 - flapW;
            const ratio = (angle - Math.PI / 2) / (Math.PI / 2);
            let alpha = 0.4 * ratio;
            if (angle >= Math.PI - 0.01) alpha = 0;
            const shadowLen = (W / 4) * ratio;

            const grad = ctx.createLinearGradient(edgeX, 0, edgeX - shadowLen, 0);
            grad.addColorStop(0, `rgba(0,0,0,${alpha})`);
            grad.addColorStop(1, "rgba(0,0,0,0)");

            ctx.fillStyle = grad;
            ctx.fillRect(edgeX - shadowLen, 0, shadowLen, H / 2);
          }
        }


      // === ã‚¯ãƒªãƒƒã‚¯åˆ¶å¾¡ ===
      let isAnimating = false;
      let isCompleted = false; // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†ãƒ•ãƒ©ã‚°
      let currentStage = 0;
      let animationProgress = 0;
      let animationStartTime = 0;
      const animationDuration = 1000; // 1ç§’ã§å®Œäº†

      function animate() {
        if (!isAnimating) return;

        const currentTime = Date.now();
        const elapsed = currentTime - animationStartTime;
        const progress = Math.min(1, elapsed / animationDuration);

        if (progress < 1) {
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç¶™ç¶š
          if (currentStage === 0) {
            drawHorizontal1(progress);
          } else if (currentStage === 1) {
            drawVertical(progress);
          } else if (currentStage === 2) {
            drawHorizontal2(progress);
          }
          requestAnimationFrame(animate);
        } else {
          // ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¸å®Œäº†
          if (currentStage === 0) {
            currentStage = 1;
            animationStartTime = currentTime;
            requestAnimationFrame(animate);
          } else if (currentStage === 1) {
            currentStage = 2;
            animationStartTime = currentTime;
            requestAnimationFrame(animate);
          } else {
            // å…¨ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†
            isAnimating = false;
            isCompleted = true; // å®Œäº†ãƒ•ãƒ©ã‚°ã‚’ç«‹ã¦ã‚‹
            currentStage = 0;
          }
        }
      }

      function startAnimation() {
        if (isAnimating || isCompleted) return; // å®Œäº†æ¸ˆã¿ã®å ´åˆã¯å®Ÿè¡Œã—ãªã„
        
        isAnimating = true;
        currentStage = 0;
        animationStartTime = Date.now();
        animate();
      }

      // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
      canvas.addEventListener("click", startAnimation);
      
      // åˆå›æç”»
      drawHorizontal1(0);
    }

    function resize() {
      // CSSã®è¨­å®šã«åˆã‚ã›ãŸã‚µã‚¤ã‚ºè¨ˆç®—
      const isMobile = window.innerWidth <= 768;
      const maxWidth = isMobile ? window.innerWidth : Math.min(500, window.innerWidth * 0.9);
      const targetHeight = isMobile ? 250 : 375;
      
      // ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã‚’ä¿æŒã—ãªãŒã‚‰ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
      const aspectRatio = origW / origH;
      let W, H;
      
      if (maxWidth / targetHeight > aspectRatio) {
        // é«˜ã•åŸºæº–
        H = targetHeight;
        W = Math.round(H * aspectRatio);
      } else {
        // å¹…åŸºæº–
        W = maxWidth;
        H = Math.round(W / aspectRatio);
      }
      
      // ãƒ‡ãƒã‚¤ã‚¹ãƒ”ã‚¯ã‚»ãƒ«æ¯”ã‚’è€ƒæ…®ã—ã¦é«˜è§£åƒåº¦ã§æç”»ï¼ˆã‚µã‚¤ã‚ºã¯å¤‰æ›´ã—ãªã„ï¼‰
      const dpr = window.devicePixelRatio || 1;
      canvas.width = W * dpr;
      canvas.height = H * dpr;
      
      // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚¹ã‚±ãƒ¼ãƒ«ã—ã¦é«˜è§£åƒåº¦å¯¾å¿œ
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      
      setupAnimation(W, H);
    }

    resize();
    window.addEventListener("resize", resize);
  };
</script>